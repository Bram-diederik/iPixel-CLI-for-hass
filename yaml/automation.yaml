alias: iPixel
description: Sends formatted info to iPixel via MQTT every minute with cycling content
triggers:
  - trigger: time_pattern
    minutes: /1
  - entity_id: input_text.ipixel_text
    trigger: state
conditions:
  - condition: state
    entity_id: input_boolean.pixel_on
    state: "on"
actions:
  - variables:
      base: >-
        {% set weather_state = states('weather.forecast_home') %} {% set
        weather_icon =
          'â˜€' if weather_state == 'sunny' else
          'â˜€' if weather_state == 'clear' else
          'ðŸŒ™' if weather_state == 'clear-night' else
          'â›…' if weather_state == 'partlycloudy' else
          'â˜' if weather_state == 'cloudy' else
          'ðŸŒ«' if weather_state == 'fog' else
          'ðŸŒ§' if weather_state == 'rainy' else
          'ðŸŒ§' if weather_state == 'pouring' else
          'â›ˆ' if weather_state == 'lightning-rainy' else
          'ðŸŒ©' if weather_state == 'lightning' else
          'ðŸŒ¨' if weather_state == 'snowy' else
          'ðŸŒ§ðŸŒ¨' if weather_state == 'snowy-rainy' else
          'ðŸ§Š' if weather_state == 'hail' else
          'ðŸƒ' if weather_state == 'windy' else
          'ðŸƒ' if weather_state == 'windy-variant' else
          'âš ï¸' if weather_state == 'exceptional' else
          'ðŸŒ¡'
        %} {% set knmi = states('sensor.knmi_weercode_2') %} {% set knmi_alert =
        ' code:' ~ knmi ~ ' ' if knmi in ['geel','oranje','rood'] else '' %} {{
        now().astimezone().strftime('%H:%M') }} {{ knmi_alert }}{{ weather_icon
        }}{{ state_attr('weather.forecast_home','temperature') }}Â°{{ 'ðŸ”¥' if
        state_attr('climate.core_mosquitto_diyless_thermostat','hvac_action') ==
        'heating' else 'ðŸŒ¡' }}{{ states('sensor.minion_temperatuur') | float |
        round(1) }}Â°
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ (states('input_text.ipixel_text') != '') and
              (states('input_text.ipixel_text') != 'unknown') }}
        sequence:
          - variables:
              final_text: "{{ states('input_text.ipixel_text') }}"
              increment: "{{ states('input_number.ipixel_count') }}"
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 0 }}"
        sequence:
          - variables:
              display: >-
                {% set netspeed = 'â¬‡' ~
                states('sensor.speedtest_download')|int|string ~
                 'mb/s â¬†' ~ states('sensor.speedtest_upload')|int|string ~ 'mb/s â±' ~
                 states('sensor.speedtest_ping')|int|string ~ 'ms' %} {% set ns =
                 namespace(output="") %} {% for server in
                 ['doorman','squire','buggy','mouse','blue_mage','vuurvliegje','karin','alfred','hushhush','kali','sascha','heppy']
                 %} {% set apt = states('sensor.' + server + '_apt_upgradeable') | int(0)
                 %}

                 {% if (states('sensor.' + server + '_root_disk_space') != 'unknown') and (states('sensor.' + server + '_root_disk_space') != 'unavailable') %}
                 
                 {% set disk = states('sensor.' + server + '_root_disk_space')  | float(0) %}
                 {% else %}
                 {% set disk = 50 %}
                 {% endif%}
                 {% if apt > 0 or disk < 6 %} {% set ns.output = ns.output +
                 server + ':' %} {% if apt > 0 %}{% set ns.output = ns.output + ' ðŸ“¦' +
                 apt|string %}{% endif %} {% if disk < 6 %}{% set ns.output = ns.output
                 + ' ðŸ’¾' + disk|round|string + '% free' %}{% endif %} {% set ns.output =
                 ns.output + ' ' %} {% endif %} {% endfor %} {% set display_text =
                 ns.output if ns.output != "" else 'All systems normal' %} {% set
                 display_icon = 'ðŸ–¥' if ns.output != "" else 'âœ…' %}
                 {{netspeed}} {{ display_icon}} {{display_text}}
              final_text: >-
                {% set t = base ~ display %} {{ t if t|length <= 100 else t[:99]
                ~ 'â€¦' }}
              increment: 1
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) ==1 }}"
        sequence:
          - data:
              type: hourly
            target:
              entity_id: weather.knmi_home
            response_variable: weather_forecast
            action: weather.get_forecasts
          - variables:
              hourly_forecast: >-
                {% set forecast = weather_forecast['weather.knmi_home'].forecast
                %} {% set
                   now_hour = now().hour %} {% set ns = namespace(output='ðŸŒ¡ ') %} {% set count
                   = 0 %} {% for hour in forecast %}
                     {% if count >= 5 %}{% break %}{% endif %}
                     {% set hour_time = as_timestamp(hour.datetime) | timestamp_custom('%H') | int %}
                     {% if hour_time > now_hour %}
                       {% set weather_icon =
                         'â˜€' if hour.condition in ['sunny','clear'] else
                         'ðŸŒ™' if hour.condition=='clear-night' else
                         'â›…' if hour.condition=='partlycloudy' else
                         'â˜' if hour.condition=='cloudy' else
                         'ðŸŒ«' if hour.condition=='fog' else
                         'ðŸŒ§' if hour.condition in ['rainy','pouring'] else
                         'â›ˆ' if hour.condition=='lightning-rainy' else
                         'ðŸŒ©' if hour.condition=='lightning' else
                         'ðŸŒ¨' if hour.condition=='snowy' else
                         'ðŸŒ§ðŸŒ¨' if hour.condition=='snowy-rainy' else
                         'ðŸ§Š' if hour.condition=='hail' else
                         'ðŸƒ' if hour.condition in ['windy','windy-variant'] else
                         'âš ï¸'
                       %}
                       {% set ns.output = ns.output ~ hour_time|string ~ 'h' ~ weather_icon ~ (hour.temperature|round) ~ 'Â° ' %}
                       {% set count = count + 1 %}
                     {% endif %}
                   {% endfor %} {{ ns.output }}
              final_text: "{{ base ~ hourly_forecast }}"
              increment: 2
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) ==2 }}"
        sequence:
          - data:
              type: daily
            target:
              entity_id: weather.knmi_home
            response_variable: weather_forecast
            action: weather.get_forecasts
          - variables:
              days_forecast: >-
                {% set forecast = weather_forecast['weather.knmi_home'].forecast
                %} {% set weekdays = ['ma','di','wo','do','vr','za','zo'] %} {%
                set ns = namespace(output='ðŸŒ¡ ') %} {% for i in range(0, 5) %} 
                {% set day = forecast[i] %} {% set wd =
                weekdays[(as_timestamp(day.datetime) | timestamp_custom('%w') |
                int -1) %7] %} {% set weather_icon =
                  'â˜€' if day.condition in ['sunny','clear'] else
                  'ðŸŒ™' if day.condition=='clear-night' else
                  'â›…' if day.condition=='partlycloudy' else
                  'â˜' if day.condition=='cloudy' else
                  'ðŸŒ«' if day.condition=='fog' else
                  'ðŸŒ§' if day.condition in ['rainy','pouring'] else
                  'â›ˆ' if day.condition=='lightning-rainy' else
                  'ðŸŒ©' if day.condition=='lightning' else
                  'ðŸŒ¨' if day.condition=='snowy' else
                  'ðŸŒ§ðŸŒ¨' if day.condition=='snowy-rainy' else
                  'ðŸ§Š' if hour.condition=='hail' else
                  'ðŸƒ' if day.condition in ['windy','windy-variant'] else
                  'âš ï¸'
                %} {% set ns.output = ns.output ~ wd ~ weather_icon ~
                (day.temperature|round) ~ 'Â° ' %} {% endfor %} {{ ns.output }}
              final_text: "{{ base ~ days_forecast }}"
              increment: 3
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 3 }}"
        sequence:
          - variables:
              news_entries: "{{ state_attr('sensor.algemeen','entries') or [] }}"
              final_text: >-
                {{ base ~ 'ðŸ“°' ~ (news_entries[0].title if news_entries|length >
                0 else 'No current news') }}
              increment: 4
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 4 }}"
        sequence:
          - variables:
              news_entries: "{{ state_attr('sensor.algemeen','entries') or [] }}"
              final_text: >-
                {{ base ~ 'ðŸ“°' ~ (news_entries[1].title if news_entries|length >
                1 else 'No more news') }}
              increment: 5
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 5 }}"
        sequence:
          - variables:
              news_entries: "{{ state_attr('sensor.algemeen','entries') or [] }}"
              final_text: >-
                {{ base ~ 'ðŸ“°' ~ (news_entries[2].title if news_entries|length >
                2 else 'No more news') }}
              increment: 6
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 6 }}"
        sequence:
          - variables:
              news_entries: "{{ state_attr('sensor.algemeen','entries') or [] }}"
              final_text: >-
                {{ base ~ 'ðŸ“°' ~ (news_entries[3].title if news_entries|length >
                3 else 'No more news') }}
              increment: 7
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 7 }}"
        sequence:
          - if:
              - condition: template
                value_template: >-
                  {{ state_attr('calendar.personal','message') or
                  state_attr('calendar.personal','summary') }}
            then:
              - variables:
                  event_title: >-
                    {{ state_attr('calendar.personal','message') or
                    state_attr('calendar.personal','summary') }}
                  event_time: >-
                    {% set start = state_attr('calendar.personal','start_time')
                    %} {{ as_timestamp(start) | timestamp_custom('%H:%M') if
                    start else '' }}
                  final_text: >-
                    {{ base ~ 'ðŸ“…' ~ (event_time + ' ' if event_time else '') ~
                    event_title }}
                  increment: 8
            else:
              - if:
                  - condition: template
                    value_template: |-
                      ## {{ states('sensor.knmi_weersverwachting') }}
                      {% set ns = namespace (found = 0) %}
                      {% set distance = 100 %}
                      {% for entity in states.geo_location %}
                        {% if entity.attributes.source == 'gdacs' and entity.state | int < distance %}
                        {% set ns.found = 1 %}
                        {% endif %}
                      {% endfor %}

                        {% if ns.found == 1 %}
                       true
                       {% else %}
                       false
                        {% endif %}
                then:
                  - variables:
                      gdacs_text: >
                        {% set ns = namespace (found = 0) %} {% set distance =
                        100 %} {% for entity in states.geo_location %} {% if
                        entity.attributes.source == 'gdacs' and entity.state |
                        int < distance %} {% set ns.found = 1 %} {{
                        entity.attributes.description }} Type: {{
                        entity.attributes.event_type }}  Level: {{
                        entity.attributes.alert_level }} Distance: {{
                        entity.state }} km {% endif %} {% endfor %}
                      final_text: "{{ base }} {{ 'ðŸŒ' + gdacs_text }}"
                      increment: 9
                else:
                  - variables:
                      quote_text: "{{ state_attr('sensor.daily_quote','q') }}"
                      quote_author: "{{ state_attr('sensor.daily_quote','a') }}"
                      final_text: >-
                        {{ base }}  ðŸ’­ {{ (quote_text ~ ' â€” ' ~ quote_author if
                        quote_text and quote_author else 'Stay inspired!') }}
                      increment: >-
                        {% set ns = namespace(voicemails=[]) %}

                        {% for state in states.sensor %} {% if
                        state.entity_id.startswith('sensor.voicemail_msg') and
                        'transcription' in state.attributes %} {% set msg_time =
                        strptime(state.attributes.timestamp, '%a %b %d %I:%M:%S
                        %p %Z %Y') %} {% set ns.voicemails = ns.voicemails + [{
                        'timestamp': msg_time.timestamp() | int, 'caller':
                        state.attributes.caller_id, 'summary':
                        state.attributes.get('summary',
                        state.attributes.transcription) }] %} {% endif %} {%
                        endfor %}

                        {% set sorted_vm = ns.voicemails %} 


                        {% if sorted_vm | length > 0 %} 10 {% else %} 0   {%
                        endif %}
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 8 }}"
        sequence:
          - if:
              - condition: template
                value_template: |-
                  ## {{ states('sensor.knmi_weersverwachting') }}
                  {% set ns = namespace (found = 0) %}
                  {% set distance = 100 %}
                  {% for entity in states.geo_location %}
                    {% if entity.attributes.source == 'gdacs' and entity.state | int < distance %}
                    {% set ns.found = 1 %}
                    {% endif %}
                  {% endfor %}

                    {% if ns.found == 1 %}
                   true
                   {% else %}
                   false
                    {% endif %}
            then:
              - variables:
                  gdacs_text: >
                    {% set ns = namespace (found = 0) %} {% set distance = 100
                    %} {% for entity in states.geo_location %} {% if
                    entity.attributes.source == 'gdacs' and entity.state | int <
                    distance %} {% set ns.found = 1 %} {{
                    entity.attributes.description }} Type: {{
                    entity.attributes.event_type }}  Level: {{
                    entity.attributes.alert_level }} Distance: {{ entity.state
                    }} km {% endif %} {% endfor %}
                  final_text: "{{ base }} {{ 'ðŸŒ' + gdacs_text }}"
                  increment: 9
            else:
              - variables:
                  quote_text: "{{ state_attr('sensor.daily_quote','q') }}"
                  quote_author: "{{ state_attr('sensor.daily_quote','a') }}"
                  final_text: >-
                    {{ base }}  ðŸ’­ {{ (quote_text ~ ' â€” ' ~ quote_author if
                    quote_text and quote_author else 'Stay inspired!') }}
                  increment: >-
                    {% set ns = namespace(voicemails=[]) %}

                    {% for state in states.sensor %} {% if
                    state.entity_id.startswith('sensor.voicemail_msg') and
                    'transcription' in state.attributes %} {% set msg_time =
                    strptime(state.attributes.timestamp, '%a %b %d %I:%M:%S %p
                    %Z %Y') %} {% set ns.voicemails = ns.voicemails + [{
                    'timestamp': msg_time.timestamp() | int, 'caller':
                    state.attributes.caller_id, 'summary':
                    state.attributes.get('summary',
                    state.attributes.transcription) }] %} {% endif %} {% endfor
                    %}

                    {% set sorted_vm = ns.voicemails %} 



                    {% if sorted_vm | length > 0 %} 10 {% else %} 0   {% endif
                    %}
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) == 9 }}"
        sequence:
          - variables:
              quote_text: "{{ state_attr('sensor.daily_quote','q') }}"
              quote_author: "{{ state_attr('sensor.daily_quote','a') }}"
              final_text: >-
                {{ base ~ 'ðŸ’­' ~ (quote_text ~ ' â€” ' ~ quote_author if
                quote_text and quote_author else 'Stay inspired!') }}
              increment: >-
                {% set ns = namespace(voicemails=[]) %}

                {% for state in states.sensor %} {% if
                state.entity_id.startswith('sensor.voicemail_msg') and
                'transcription' in state.attributes %} {% set msg_time =
                strptime(state.attributes.timestamp, '%a %b %d %I:%M:%S %p %Z
                %Y') %} {% set ns.voicemails = ns.voicemails + [{ 'timestamp':
                msg_time.timestamp() | int, 'caller':
                state.attributes.caller_id, 'summary':
                state.attributes.get('summary', state.attributes.transcription)
                }] %} {% endif %} {% endfor %}

                {% set sorted_vm = ns.voicemails | sort(attribute='timestamp')
                %} {% set count = states('input_number.ipixel_count') | int %}


                {% set current_index = count - 10 %} 

                {% set next_index = current_index + 1 %}

                {% if sorted_vm | length > next_index %} {{ next_index + 10 }} 
                {% else %} 0   {% endif %}
      - conditions:
          - condition: template
            value_template: "{{ (states('input_number.ipixel_count') | int) > 9 }}"
        sequence:
          - variables:
              final_text: >-
                {% set ns = namespace(voicemails=[]) %}

                {% for state in states.sensor %} {% if
                state.entity_id.startswith('sensor.voicemail_msg') and
                'transcription' in state.attributes %} {% set msg_time =
                strptime(state.attributes.timestamp, '%a %b %d %I:%M:%S %p %Z
                %Y') %} {% set ns.voicemails = ns.voicemails + [{ 'timestamp':
                msg_time.timestamp() | int, 'caller':
                state.attributes.caller_id, 'summary':
                state.attributes.get('summary', state.attributes.transcription)
                }] %} {% endif %} {% endfor %} {# Sort earliest first #} {% set
                sorted_vm = ns.voicemails | sort(attribute='timestamp') %} {#
                Get the starting index based on ipixel_count #} {% set count =
                states('input_number.ipixel_count') | int %} {% set index =
                count - 10 %} 


                {% set vm = sorted_vm[index] if sorted_vm | length > index else
                none %}

                {% if vm %} {# Local time HH:mm #} {% set local_time =
                vm.timestamp | timestamp_custom('%H:%M', true) %}

                {# Parse caller: NAME<NUMBER> or <NUMBER> #} {% set raw =
                vm.caller %} {% if '<' in raw and '>' in raw %} {% set name =
                raw.split('<')[0] | trim %} {% set number =
                raw.split('<')[1].split('>')[0] | trim %} {% if name|lower in
                ['unknown', 'onbekend', ''] %} {% set caller = number %} {% else
                %} {% set caller = name %} {% endif %} {% else %} {% set caller
                = raw %} {% endif %}

                {# Current voicemail text #} {% set final_text = "ðŸ•’ " ~
                local_time ~ " â€“ " ~ caller ~ " â€“ " ~ vm.summary %} {% else %}
                {% set final_text = "No voicemail" %} {% endif %} {{base}}{{
                final_text }}
              increment: >-
                {% set ns = namespace(voicemails=[]) %}

                {% for state in states.sensor %} {% if
                state.entity_id.startswith('sensor.voicemail_msg') and
                'transcription' in state.attributes %} {% set msg_time =
                strptime(state.attributes.timestamp, '%a %b %d %I:%M:%S %p %Z
                %Y') %} {% set ns.voicemails = ns.voicemails + [{ 'timestamp':
                msg_time.timestamp() | int, 'caller':
                state.attributes.caller_id, 'summary':
                state.attributes.get('summary', state.attributes.transcription)
                }] %} {% endif %} {% endfor %}

                {% set sorted_vm = ns.voicemails | sort(attribute='timestamp')
                %} {% set count = states('input_number.ipixel_count') | int %}


                {% set current_index = count - 10 %} 

                {% set next_index = current_index + 1 %}

                {% if sorted_vm | length > next_index %} {{ next_index + 10 }} 
                {% else %} 0   {% endif %}
  - data:
      value: "{{  increment }}"
    action: input_number.set_value
    target:
      entity_id: input_number.ipixel_count
  - variables:
      final_text: >-
        {{ (final_text|replace('"', "'") ) if final_text|length <= 100 else
        (final_text[:99]|replace('"', "'") ~ 'â€¦') }}
  - data:
      topic: ipixel/6554874a3e63/set
      qos: 1
      retain: true
      payload: |-
        {
          "command": "send_text",
          "params": [
            "text={{ final_text }}",
            "color=0006b1",
            "speed=75",
            "animation=1",
            "font=gnufont"
          ]
        }
    action: mqtt.publish
mode: restart
